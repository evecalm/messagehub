/*!
 * duplex-message
 * CopyrightÂ© 2021 Saiya https://github.com/oe/duplex-message
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).DuplexMessage={})}(this,(function(e){"use strict";var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,n)};function n(e,n){function s(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(s.prototype=n.prototype,new s)}function s(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))}function o(e,t){var n,s,o,r,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,s&&(o=2&r[0]?s.return:r[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,r[1])).done)return o;switch(s=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return i.label++,{value:r[1],done:!1};case 5:i.label++,s=r[1],r=[0];continue;case 7:r=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==r[0]&&2!==r[0])){i=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){i.label=r[1];break}if(6===r[0]&&i.label<o[1]){i.label=o[1],o=r;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(r);break}o[2]&&i.ops.pop(),i.trys.pop();continue}r=t.call(e,i)}catch(e){r=[6,e],s=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}function r(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var s=Array(e),o=0;for(t=0;t<n;t++)for(var r=arguments[t],i=0,a=r.length;i<a;i++,o++)s[o]=r[i];return s}var i=function(){function e(){this.instanceID=e.generateInstanceID(),this._eventHandlerMap=[],this._messageID=0}return e.prototype._hasListeners=function(){return this._eventHandlerMap.length>0},e.prototype._on=function(e,t,n){var s,o,r=this._eventHandlerMap.find((function(t){return t[0]===e}));if("string"==typeof t?((s={})[t]=n,o=s):o=t,r){var i=r[1];r[1]="function"==typeof i||"function"==typeof o?o:Object.assign({},i,o)}else this._eventHandlerMap["*"===e?"unshift":"push"]([e,o])},e.prototype._off=function(e,t){var n=this._eventHandlerMap.findIndex((function(t){return t[0]===e}));if(-1!==n)if(t){var s=this._eventHandlerMap[n][1];"object"==typeof s&&(delete s[t],Object.keys(s).length||this._eventHandlerMap.splice(n,1))}else this._eventHandlerMap.splice(n,1)},e.prototype.onRequest=function(e,t){return s(this,void 0,void 0,(function(){var n,s,r,i,a,c,u;return o(this,(function(o){switch(o.label){case 0:if(o.trys.push([0,2,,3]),n=this._eventHandlerMap.find((function(t){return t[0]===e}))||this._eventHandlerMap[0],s=t.methodName,r=t.args,i=n&&n[1],a=void 0,"function"==typeof i?(a=i,r.unshift(s)):a=i&&i[s],"function"!=typeof a)throw console.warn("[MessageHub] no corresponding handler found for "+s+", message from",e),new Error("[MessageHub] no corresponding handler found for "+s);return[4,a.apply(null,r)];case 1:return c=o.sent(),[2,this._buildRespMessage(c,t,!0)];case 2:throw u=o.sent(),this._buildRespMessage(u,t,!1);case 3:return[2]}}))}))},e.prototype._emit=function(e,t){for(var n=this,s=[],o=2;o<arguments.length;o++)s[o-2]=arguments[o];var r=this._buildReqMessage(t,s);return this.sendMessage(e,r),new Promise((function(t,s){n.listenResponse(e,r,(function(e){return!!n._isResponse(r,e)&&(e.isSuccess?t(e.data):s(e.data),!0)}))}))},e.prototype._buildReqMessage=function(t,n){return e.buildReqMsg(this.instanceID,++this._messageID,t,n)},e.prototype._buildRespMessage=function(t,n,s){return e.buildRespMsg(this.instanceID,t,n,s)},e.prototype._isRequest=function(e){return Boolean(e&&e.fromInstance&&e.fromInstance!==this.instanceID&&(!e.toInstance||e.toInstance===this.instanceID)&&e.messageID&&"request"===e.type)},e.prototype._isResponse=function(e,t){return e&&e&&t.toInstance===this.instanceID&&t.toInstance===e.fromInstance&&t.messageID===e.messageID&&"response"===t.type},e.generateInstanceID=function(){return Math.random().toString(36).slice(2)},e.buildReqMsg=function(e,t,n,s,o){return{fromInstance:e,toInstance:o,messageID:t,type:"request",methodName:n,args:s}},e.buildRespMsg=function(e,t,n,s){return{fromInstance:e,toInstance:n.fromInstance,messageID:n.messageID,type:"response",isSuccess:s,data:t}},e}(),a=self,c="undefined"==typeof document,u=function(e){function t(){var t=e.call(this)||this;return t._hostedWorkers=[],t._onMessageReceived=t._onMessageReceived.bind(t),t.proxyMessage=t.proxyMessage.bind(t),a.addEventListener("message",t._onMessageReceived),t}return n(t,e),t.prototype.on=function(t,n,s){e.prototype._on.call(this,t,n,s),t instanceof Worker&&!this._hostedWorkers.includes(t)&&(this._hostedWorkers.push(t),t.addEventListener("message",this._onMessageReceived))},t.prototype.emit=function(e,t){for(var n=[],s=2;s<arguments.length;s++)n[s-2]=arguments[s];return this._emit(e,t,n)},t.prototype.off=function(t,n){if(e.prototype._off.call(this,t,n),t instanceof Worker){t.removeEventListener("message",this._onMessageReceived);var s=this._hostedWorkers.indexOf(t);s>-1&&this._hostedWorkers.splice(s,1)}},t.prototype.createDedicatedMessageHub=function(e){var t=this,n=e,s=function(){if(!n)throw new Error("peer is not set in dedicated message-hub")};return{setPeer:function(e){n=e},emit:function(e){for(var o=[],i=1;i<arguments.length;i++)o[i-1]=arguments[i];return s(),t.emit.apply(t,r([n,e],o))},on:function(e,o){var r;s();var i="string"==typeof e?((r={})[e]=o,r):e;t.on(n,i)},off:function(e){if(s(),!e)return t.off(n);var o=t._eventHandlerMap.find((function(e){return e[0]===n}));o&&delete o[e]}}},t.prototype.createProxy=function(e,t){if(c)throw new Error("[MessageHub] createProxy can only be used in a normal window context");if(a===e||a===t||e===t)throw new Error("[MessageHub] can not forward message to own");this.on(e,this.proxyMessage(t))},t.prototype.proxyMessage=function(e){var t=this;return function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];return t.emit.apply(t,r([e],n))}},t.prototype.createProxyFor=function(e){this.createProxy(e,a.parent)},t.prototype._onMessageReceived=function(e){return s(this,void 0,void 0,(function(){var t,n,s,r;return o(this,(function(o){switch(o.label){case 0:if(t=e.data,!this._isRequest(t))return[2];n=e.source||e.currentTarget||a,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.onRequest(n,t)];case 2:return s=o.sent(),[3,4];case 3:return r=o.sent(),s=r,[3,4];case 4:return this.sendMessage(n,s),[2]}}))}))},t.prototype.sendMessage=function(e,t){var n=[t];"function"==typeof Window&&e instanceof Window&&n.push("*"),e.postMessage.apply(e,n)},t.prototype.listenResponse=function(e,t,n){var s=!c&&e instanceof Worker?e:a,o=function(e){n(e.data)&&s.removeEventListener("message",o)};s.addEventListener("message",o)},t}(i),f=function(e){function t(){var t=this;if("undefined"==typeof window||"undefined"==typeof localStorage)throw new Error("StorageMessageHub only available in normal browser context, nodejs/worker are not supported");return(t=e.call(this)||this)._responseCallbacks=[],t._onMessageReceived=t._onMessageReceived.bind(t),t._isEventAttached=!1,t}return n(t,e),t.prototype.on=function(t,n){e.prototype._on.call(this,"*",t,n),this._isEventAttached||(window.addEventListener("storage",this._onMessageReceived),this._isEventAttached=!0)},t.prototype.emit=function(t){for(var n=[],s=1;s<arguments.length;s++)n[s-1]=arguments[s];return e.prototype._emit.apply(this,r(["*",t],n))},t.prototype.off=function(t){e.prototype._off.call(this,"*",t),(!this._hasListeners()||t&&this._isEventAttached)&&(window.removeEventListener("storage",this._onMessageReceived),this._isEventAttached=!1)},t.prototype.sendMessage=function(e,n){var s=t._getMsgKey(n);localStorage.setItem(s,JSON.stringify(n))},t.prototype.listenResponse=function(e,n,s){this._responseCallbacks.push((function(e){return!!s(e)&&(localStorage.removeItem(t._getMsgKey(e)),!0)}))},t.prototype._onMessageReceived=function(e){return s(this,void 0,void 0,(function(){var n,s,r,i;return o(this,(function(o){switch(o.label){case 0:if(console.warn("storage event",e),!(n=t._getMsgFromEvent(e)))return[2];if(!this._isRequest(n))return(s=this._responseCallbacks.findIndex((function(e){return e(n)})))>=0?this._responseCallbacks.splice(s,1):n.toInstance===this.instanceID&&"response"===n.type&&localStorage.removeItem(t._getMsgKey(n)),[2];setTimeout((function(){null!==localStorage.getItem(e.key)&&localStorage.removeItem(e.key)}),100+Math.floor(1e3*Math.random())),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.onRequest("*",n)];case 2:return r=o.sent(),[3,4];case 3:return i=o.sent(),r=i,[3,4];case 4:return this.sendMessage("*",r),[2]}}))}))},t._getMsgFromEvent=function(e){if(e.key&&/^\$\$msghub\-/.test(e.key)&&e.newValue){var t;try{t=JSON.parse(e.newValue)}catch(e){return}return t}},t._getMsgKey=function(e){return"$$msghub-"+e.type+"-"+e.fromInstance+"-"+(e.toInstance||"")+"-"+e.messageID},t}(i),p=function(e){function t(t){void 0===t&&(t="message-hub");var n=this;if("undefined"==typeof window||"undefined"==typeof localStorage)throw new Error("StorageMessageHub only available in normal browser context, nodejs/worker are not supported");return(n=e.call(this)||this)._customEventName=t,n._responseCallbacks=[],n._onMessageReceived=n._onMessageReceived.bind(n),n._isEventAttached=!1,n}return n(t,e),t.prototype.on=function(t,n){e.prototype._on.call(this,"*",t,n),this._isEventAttached||window.addEventListener(this._customEventName,this._onMessageReceived)},t.prototype.emit=function(t){for(var n=[],s=1;s<arguments.length;s++)n[s-1]=arguments[s];return e.prototype._emit.apply(this,r(["*",t],n))},t.prototype.off=function(t){e.prototype._off.call(this,"*",t),(!this._hasListeners()||!t&&this._isEventAttached)&&(window.removeEventListener(this._customEventName,this._onMessageReceived),this._isEventAttached=!1)},t.prototype._onMessageReceived=function(e){return s(this,void 0,void 0,(function(){var t,n,s,r;return o(this,(function(o){switch(o.label){case 0:if(!(t=e.detail))return[2];if(!this._isRequest(t))return(n=this._responseCallbacks.findIndex((function(e){return e(t)})))>=0&&this._responseCallbacks.splice(n,1),[2];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.onRequest("*",t)];case 2:return s=o.sent(),[3,4];case 3:return r=o.sent(),s=r,[3,4];case 4:return this.sendMessage("*",s),[2]}}))}))},t.prototype.sendMessage=function(e,t){var n=new CustomEvent(this._customEventName,{detail:t});window.dispatchEvent(n)},t.prototype.listenResponse=function(e,t,n){this._responseCallbacks.push(n)},t}(i);e.AbstractHub=i,e.PageScriptMessageHub=p,e.PostMessageHub=u,e.StorageMessageHub=f,Object.defineProperty(e,"__esModule",{value:!0})}));
