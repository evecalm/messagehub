/*!
 * @evecalm/message-hub v0.1.3
 * Copyright© 2019 Saiya https://github.com/oe/messagehub
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.MessageHub=t()}(this,function(){"use strict";
/*!
     * Composie v0.1.2
     * Copyright© 2019 Saiya https://github.com/oe/composie#readme
     */var e=function(){function e(){this.wildcard=Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2),this.middlewares={},this.routers={}}return e.prototype.use=function(e,t){var r;return"function"==typeof e?(t=e,r=this.wildcard):r=e,this.addMiddleware(r,t),this},e.prototype.route=function(e){for(var t,r=this,i=[],s=1;s<arguments.length;s++)i[s-1]=arguments[s];return"string"==typeof e&&((t={})[e]=i,e=t),Object.keys(e).forEach(function(t){var i,s=e[t];Array.isArray(s)||(s=[s]),s.length&&(r.routers[t]||(r.routers[t]=[]),(i=r.routers[t]).push.apply(i,s))}),this},e.prototype.run=function(e,t){var r,i=this,s=(r="string"==typeof e?this.createContext(e,t):e).channel,n=this.getMiddlewares(s),o=this.routers[s]||[];return n.push.apply(n,o),new Promise(function(e,t){n.length?i.composeMiddlewares(n)(r).then(function(){return e(r.response)}).catch(t):(console.warn("no corresponding router for",s),e())})},e.prototype.addMiddleware=function(e,t){var r,i,s,n=this.middlewares;if(e===this.wildcard)return this.middlewares[e]||(this.middlewares=((r={})[e]={mdlws:[],children:n},r)),void this.middlewares[e].mdlws.push(t);for(this.middlewares[this.wildcard]&&(n=this.middlewares[this.wildcard].children);n;){for(var o=Object.keys(n),a=o.length,h=0,d="";a--;){if((d=o[a])===e){h=1;break}if(0===e.indexOf(d)){h=2;break}if(0===d.indexOf(e)){h=3;break}}if(!h)break;if(1===h)return void n[d].mdlws.push(t);if(2===h){if(n[d].children){n=n[d].children;continue}return void(n[d].children=(i={},i[e]={mdlws:[t]},i))}if(3===h){var c=n[d];return delete n[d],void(n[e]={mdlws:[t],children:(s={},s[d]=c,s)})}}n[e]={mdlws:[t]}},e.prototype.composeMiddlewares=function(e){return function(t,r){var i=-1;return function s(n){if(n<=i)return Promise.reject(new Error("next() called multiple times"));i=n;var o=e[n];n===e.length&&(o=r);if(!o)return Promise.resolve();try{return Promise.resolve(o(t,s.bind(null,n+1)))}catch(e){return Promise.reject(e)}}(0)}},e.prototype.createContext=function(e,t){return{channel:e,request:t}},e.prototype.getMiddlewares=function(e){var t=this.middlewares,r=[];for(t[this.wildcard]&&(r.push.apply(r,t[this.wildcard].mdlws),t=t[this.wildcard].children);t;){var i=Object.keys(t).find(function(t){return-1!==e.indexOf(t)});if(void 0===i)break;r.push.apply(r,t[i].mdlws),t=t[i].children}return r},e}(),t={channel:"THIS_IS_MESSAGE_SECRET_CHANNEL",id:-1};return function(){function r(r){if(this.count=0,this.isWorker=!1,this.targetOrigin="*",this.evtsCbs={},this.promisePairs={},this.isReady=!1,this.composie=new e,this.context=self,this.type=r.type,"worker"===r.type)if(this.isReady=!0,this.isWorker="undefined"==typeof document,this.isWorker)this.peer=self;else{if(!r.peer)throw new Error("[@evecalm/message-hub]a worker instance is required");this.peer=r.peer,this.context=r.peer}else{if("frame"!==r.type)throw new Error("unsupported type "+r.type);if(!r.peer)throw new Error("[@evecalm/message-hub]a peer window instance is required");if(r.peer===self)throw new Error("[@evecalm/message-hub] peer is the same of current context(window), use node module `composie` instead for messaging in the same context");this.peer=r.peer,r.targetOrigin&&(this.targetOrigin=r.targetOrigin)}this.onMessage=this.onMessage.bind(this),this.context.addEventListener("message",this.onMessage),this.isReady||this.emit(t.channel)}return r.prototype.ready=function(){var e=this;return this.context?this.isReady?Promise.resolve(this):new Promise(function(r,i){e.fetch(t.channel).then(function(){e.isReady=!0,r(e)},i)}):Promise.reject(new Error("This MessageHub instance has been destroyed"))},r.prototype.use=function(e){return this.composie&&this.composie.use(e),this},r.prototype.route=function(e){for(var t,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];return this.composie?("string"==typeof e?(t=this.composie).route.apply(t,[e].concat(r)):this.composie.route(e),this):this},r.prototype.fetch=function(e,t,r){var i={type:"request",channel:e,data:t,transfers:r};return this.postMessage(i,!0)},r.prototype.on=function(e,t){this.evtsCbs[e]||(this.evtsCbs[e]=[]),this.evtsCbs[e].push(t)},r.prototype.off=function(e,t){if(this.evtsCbs[e]&&this.evtsCbs[e].length)if(t){for(var r=this.evtsCbs[e],i=r.length;i--;)if(r[i]===t){r.splice(i,1);break}}else this.evtsCbs[e]=[]},r.prototype.emit=function(e,t,r){var i={type:"request",channel:e,data:t,transfers:r};this.postMessage(i,!1)},r.prototype.destroy=function(){this.context&&(this.context.removeEventListener("message",this.onMessage),this.evtsCbs={},this.composie=null,"worker"===this.type&&(this.isWorker?this.context.close():this.context.terminate()),this.context=null,this.peer=null)},r.prototype.createContext=function(e){var t=e.data;return{id:t.id,type:"request",channel:t.channel,request:t.data,event:e}},r.prototype.onMessage=function(e){var t=this;if("frame"!==this.type||(!e.source||e.source===this.peer)&&this.isValidateOrigin(e.origin)){var r=e.data;if(r&&this.composie&&r.channel)if(r.id)if("response"===r.type)this.resolveFetch(r);else{var i=this.createContext(e);if(this.resolveFetch(r))return void this.respond(i,!0);this.composie.run(i).then(function(){t.respond(i,!0)},function(e){console.warn("run middleware failed",e),t.respond(i,!1)})}else{if(this.resolveFetch(r))return;var s=this.evtsCbs[r.channel];if(!s||!s.length)return void console.warn("no corresponed callback for",r.channel);for(var n=0;n<s.length;n++){if(!1===(0,s[n])(r.data))break}}}},r.prototype.respond=function(e,t){var r={resolved:t,id:e.id,channel:e.channel,type:"response",data:e.response};this.postMessage(r)},r.prototype.resolveFetch=function(e){if(e.id&&("request"!==e.type||e.id===t.id)){var r=e.id,i=this.promisePairs[r];return i?((0,i[!1!==e.resolved?0:1])(e.data),delete this.promisePairs[r],!0):e.id===t.id||void console.warn("unowned message with id",r,e)}},r.prototype.isValidateOrigin=function(e){return"*"===this.targetOrigin||e===this.targetOrigin},r.prototype.postMessage=function(e,r){var i,s=this,n=[e];if("frame"===this.type&&n.push(this.targetOrigin),"request"===e.type){e.id=e.channel===t.channel?t.id:r?++this.count:0;var o=e.transfers;delete e.transfers,o&&n.push(o)}if((i=this.peer).postMessage.apply(i,n),"response"!==e.type&&e.id)return new Promise(function(t,r){s.promisePairs[e.id]=[t,r]})},r}()});
