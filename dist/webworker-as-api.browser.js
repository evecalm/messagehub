/*!
 * webworker-as-api v0.0.1
 * Copyright© 2018 Saiya https://evecalm.com/
 */
!function(e,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):e.WorkerServer=s()}(this,function(){"use strict";
/*!
     * Composie v0.0.11
     * Copyright© 2018 Saiya https://github.com/evecalm/composie#readme
     */class e{constructor(){this.wildcard=Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2),this.middlewares={},this.routers={}}use(e,s){let t;return"function"==typeof e?(s=e,t=this.wildcard):t=e,this.addMiddleware(t,s),this}route(e,...s){return"string"==typeof e&&(e={[e]:s}),Object.keys(e).forEach(s=>{let t=e[s];Array.isArray(t)||(t=[t]),t.length&&(this.routers[s]||(this.routers[s]=[]),this.routers[s].push(...t))}),this}run(e,s){let t;const r=(t="string"==typeof e?this.createContext(e,s):e).channel,i=this.getMiddlewares(r),n=this.routers[r]||[];return i.push(...n),new Promise((s,r)=>{if(i.length){this.composeMiddlewares(i)(t).then(()=>s(t.response)).catch(r)}else console.warn(`no corresponding router for ${e}`),s()})}addMiddleware(e,s){let t=this.middlewares;if(e===this.wildcard)return this.middlewares[e]||(this.middlewares={[e]:{mdlws:[],children:t}}),void this.middlewares[e].mdlws.push(s);for(this.middlewares[this.wildcard]&&(t=this.middlewares[this.wildcard].children);t;){const r=Object.keys(t);let i=r.length,n=0,o="";for(;i--;){if((o=r[i])===e){n=1;break}if(0===e.indexOf(o)){n=2;break}if(0===o.indexOf(e)){n=3;break}}if(!n)break;if(1===n)return void t[o].mdlws.push(s);if(2===n){if(t[o].children){t=t[o].children;continue}return void(t[o].children={[e]:{mdlws:[s]}})}if(3===n){const r=t[o];return delete t[o],void(t[e]={mdlws:[s],children:{[o]:r}})}}t[e]={mdlws:[s]}}composeMiddlewares(e){return function(s,t){let r=-1;return function i(n){if(n<=r)return Promise.reject(new Error("next() called multiple times"));r=n;let o=e[n];n===e.length&&(o=t);if(!o)return Promise.resolve();return Promise.resolve(o(s,i.bind(null,n+1)))}(0)}}createContext(e,s){return{channel:e,request:s}}getMiddlewares(e){let s=this.middlewares;const t=[];for(s[this.wildcard]&&(t.push(...s[this.wildcard].mdlws),s=s[this.wildcard].children);s;){const r=Object.keys(s).find(s=>-1!==e.indexOf(s));if(void 0===r)break;t.push(...s[r].mdlws),s=s[r].children}return t}}return class{constructor(s){if(this.count=0,this.evtsCbs={},this.promisePairs={},this.composie=new e,"undefined"==typeof document)this.worker=self;else{if(!s)throw new Error("a worker for worker script is required");this.worker=s}this.onMessage=this.onMessage.bind(this),this.worker.addEventListener("message",this.onMessage)}use(e){return this.composie.use(e),this}route(e,...s){return"string"==typeof e?this.composie.route(e,...s):this.composie.route(e),this}fetch(e,s,t){const r={type:"request",channel:e,data:s,transfers:t};return this.postMessage(r,!0)}on(e,s){this.evtsCbs[e]||(this.evtsCbs[e]=[]),this.evtsCbs[e].push(s)}off(e,s){if(!this.evtsCbs[e]||!this.evtsCbs[e].length)return;if(!s)return void(this.evtsCbs[e]=[]);const t=this.evtsCbs[e];let r=t.length;for(;r--;)if(t[r]===s){t.splice(r,1);break}}emit(e,s,t){const r={type:"request",channel:e,data:s,transfers:t};this.postMessage(r,!1)}createContext(e){const s=e.data;return console.warn("evt",e),{id:s.id,type:"request",channel:s.channel,request:s.data,event:e}}onMessage(e){const s=e.data;if(s.id)if("response"===s.type){const e=this.promisePairs[s.id];if(!e)return void console.warn("unowned message with id",s.id);(0,e[s.resolved?0:1])(s.data)}else{const s=this.createContext(e);this.composie.run(s).then(()=>{const e={resolved:!0,id:s.id,channel:s.channel,type:"response",data:s.response};this.postMessage(e)},e=>{console.warn("run middleware failed",e);const t={resolved:!1,id:s.id,channel:s.channel,type:"response",data:s.response};this.postMessage(t)})}else{const e=this.evtsCbs[s.channel];if(!e||!e.length)return void console.warn(`no corresponed callback for ${s.channel}`);for(let t=0;t<e.length&&!1!==(0,e[t])(s.data);t++);}}postMessage(e,s){const t=[e];if("request"===e.type){e.id=s?++this.count:0;const r=e.transfers;delete e.transfers,r&&t.push(r)}if(this.worker.postMessage(...t),"response"!==e.type&&e.id)return new Promise((s,t)=>{this.promisePairs[e.id]=[s,t]})}}});
